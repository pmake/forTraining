<!DOCTYPE html>
<html> 
    <head> 
        <meta charset="UTF-8">
        <title>e-Board</title>

        <!-- 自訂 css --> 
        <style> 
            <!-- 
            html, body, div{ 
                margin: 0 auto; 
                padding: 0; 
                font-family: "微軟正黑體", "Oswald", sans-serif; 
            }

            #wrapper{ 
                margin: 15px auto; 
                padding: 0; 
                width: 1000px; 
                height: 800px; 
                border: 2px solid; 
                position:relative;
            }

            #menu{ 
                float: left; 
                width: 300px; 
                height: 774px; 
                margin: 10px; 
                border: 2px solid; 
            }

            #content{ 
                float: left; 
                width: 652px; 
                height: 774px; 
                margin: 10px; 
                border: 2px solid; 
            }

            .clear{ 
                clear: left; 
            } 
            form {
                position: absolute;
                top:750px;
                left:50px;
            }
            ul {
                list-style-type: none;
                margin-top:-5px;
            }
            --> 
        </style>


    </head> 
    <body> 
        <div id="wrapper">
            <div id="menu">
                <div id="settings">
                    線條寬:
                    <select id="size">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                    &nbsp;畫筆<input type="radio" name="drawmode" id="draw" checked>
                    擦子<input type="radio" name="drawmode" id="era">
                    <input type="button" id="cleaner" value="清空畫布">
                </div> 
                <hr />
                <ul id="member_msg"></ul>
            </div> 
            <div id="content">
                <canvas id="whiteboard"></canvas>
            </div> 
            <div class="clear"></div>
            <form action="">
                <input id="m" autocomplete="off" /><button>Send</button>
            </form>
        </div> 
        <!-- 外部 javascript --> 
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.11.1.js"></script>

        <!-- 自訂 javascript --> 
        <script> 
            //尚有在既存連線在更改設定後按清除畫布(會清空server的設定記錄)，新連線連線後設定不一致問題，此問題在限定主畫者功能時再解
            var userName = prompt('尊姓大名？'); //socket連線建立後使用prompt會額外建立socket，所以要在連線建立之前使用

            //紀錄訊息筆數
            var msgNum = 0;
            //建立socket連線 
            var socket = io();


            //將輸入名稱傳到後端 node.js server 來通知其他人您已上線的訊息 
            socket.emit('login', userName); 
            //接收歷史資料並載入
            socket.on('transport history',function(data1,data2){
                //載入既存圖畫
                data1.forEach(function(value){
                    if(value[0]==='s'){
                        $('#size').val(value[1]);
                        (value[2]=='#ffffff')?$('#era').prop('checked',true):$('#draw').prop('checked',true);
                        ctx.lineWidth = value[1];
                        ctx.strokeStyle = value[2];
                    }else if(value[0]==='d'){
                        ctx.beginPath();  
                        ctx.moveTo(value[1], value[2]);  
                        ctx.lineTo(value[3], value[4]);  
                        ctx.closePath();  
                        ctx.stroke();   
                    }
                })
                //載入既存聊天訊息
                data2.forEach(function(value){
                    $('#member_msg').append($('<li>').text(value));
                    msgNum+=1;
                })
            });
            //上線通知 
            socket.on('msg', function(data){ 
                if (msgNum > 32) {
                    $('li:first-child').remove();
                    $('#member_msg').append($('<li>').text(data));
                }else {
                    $('#member_msg').append($('<li>').text(data));
                    msgNum+=1;
                }
            }); 

            //別人畫布上的動作，呈現在我們自己的頁面上 
            socket.on('show', function(data){ 
                //繪圖 
                ctx.beginPath();  
                ctx.moveTo(data.x, data.y);  
                ctx.lineTo(data.new_x, data.new_y);  
                ctx.closePath();  
                ctx.stroke(); 
            }); 

            /* 繪圖相關設定 */ 
            //宣告 canvas 元素 
            var c = document.getElementsByTagName('canvas')[0]; 

            //設定 canvas 寬與高 
            c.width  = 648; 
            c.height = 770; 

            //判斷畫布是否有動作的布林變數 
            var drawing = false; 

            //canvas 元素本身沒有畫作能力，僅為圖形容器，需要使用 javascript 來操作畫布 
            //我們須要透過 getContext() 來取得一個提供在 canvas 上畫圖的方法與屬性之「物件」 
            var ctx = c.getContext('2d'); 

            //繪圖物件初始設定 
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round'; 
            ctx.strokeStyle = '#000000'; 
            ctx.lineWidth = 1; 

            //座標相關變數 
            var offset, x, y, new_x, new_y; 

            //滑鼠在畫布按下時的事件處理 
            $(document).on('mousedown', '#whiteboard', function(e){
                e.preventDefault(); 

                //打開可供畫圖的機制 
                drawing = true; 

                //計算相對的畫布範圍（這很重要） 
                offset = $(e.currentTarget).offset(); 
                x = e.pageX - offset.left;  
                y = e.pageY - offset.top; 
                drawLine(x, y, x+1, y+1); 
            }); 

            //滑鼠在畫布上按下左右時，移動的情況 
            $(document).on('mousemove', '#whiteboard', function(e){ 
                e.preventDefault(); 

                //是否開啟畫圖機制 
                if( drawing ) 
                { 
                    //計算移動後的新座標，再進行畫圖作業 
                    new_x = e.pageX - offset.left; 
                    new_y = e.pageY - offset.top; 
                    drawLine(x, y, new_x, new_y); 
                    x = new_x; 
                    y = new_y; 
                } 
            }); 

            //放開滑鼠鍵 
            $(document).on('mouseup', '#whiteboard', function(e){ 
                e.preventDefault(); 

                //關閉繪圖機制 
                drawing = false; 
            }); 

            //設定變更處理
            $('#settings').on('change',function(){
                ctx.lineWidth = $('#size').val();
                ($('#draw').prop('checked'))? ctx.strokeStyle='#000000':ctx.strokeStyle='#ffffff';
                var settings = {};
                settings.size = ctx.lineWidth;
                settings.color = ctx.strokeStyle;
                socket.emit('settings changed',settings);
            });

            socket.on('settings changed',function(settings){
                $('#size').val(settings.size);
                ctx.lineWidth = settings.size;
                ctx.strokeStyle = settings.color;
                (settings.color=='#ffffff')?$('#era').prop('checked',true):$('#draw').prop('checked',true);
            });
            //畫圖，並將繪畫座標傳給網頁上的其他使用者 
            function drawLine(x, y, new_x, new_y) 
            {  
                //繪圖 
                ctx.beginPath();  
                ctx.moveTo(x, y);  
                ctx.lineTo(new_x, new_y);  
                ctx.closePath();  
                ctx.stroke(); 

                //將繪畫座標透過 node.js 傳給使用者 
                var obj = {}; 
                obj.x = x; 
                obj.y = y; 
                obj.new_x = new_x; 
                obj.new_y = new_y; 
                socket.emit('draw', obj); 
            }
            //聊天功能
            $('form').submit(function(){
                if ($('#m').val() !== '') socket.emit('chat message', $('#m').val());
                $('#m').val('');
                return false;//避免重新導向(載入)
            });
            //清除畫布
            $('#cleaner').click(function(){
                ctx.clearRect(0,0,c.width,c.height);
                socket.emit('clear canvas');
            });
            socket.on('clear canvas', function(){
                ctx.clearRect(0,0,c.width,c.height);
            });

            socket.on('chat message',function(msg){
                if (msgNum > 32) {
                    $('li:first-child').remove();
                    $('#member_msg').append($('<li>').text(msg));
                }else {
                    $('#member_msg').append($('<li>').text(msg));
                    msgNum+=1;
                }
            });
        </script> 
    </body> 
</html>